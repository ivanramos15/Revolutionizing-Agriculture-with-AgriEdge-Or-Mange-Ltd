// ===========================
// Apex Class: OrderTaskCreator
// ===========================
public with sharing class OrderTaskCreator {
    @InvocableMethod
    public static void createTaskForNewOrder(List<Id> orderIds) {
        if (orderIds == null || orderIds.isEmpty()) return;

        // Fetch users with Profile Name 'Platform 1'
        List<User> platformUsers = [SELECT Id FROM User WHERE Profile.Name = 'Platform 1' LIMIT 10];

        if (platformUsers.isEmpty()) {
            System.debug('No users found with Platform 1 profile.');
            return;
        }

        List<Task> tasks = new List<Task>();
        for (Id orderId : orderIds) {
            for (User user : platformUsers) {
                Task newTask = new Task(
                    Subject = 'New Order Created',
                    Description = 'A new order has been created. Please create an Order Item record.',
                    WhatId = orderId,
                    OwnerId = user.Id,
                    Status = 'Not Started',
                    Priority = 'High'
                );
                tasks.add(newTask);
            }
        }

        if (!tasks.isEmpty()) insert tasks;
    }
}

// ===========================
// Apex Class: OrderStatusUpdater
// ===========================
public class OrderStatusUpdater {
    public static void updateOrderStatus(Set<Id> orderIds) {
        if (orderIds == null || orderIds.isEmpty()) return;

        List<AgriEdge_Order__c> ordersToUpdate = [
            SELECT Id, Order_Status__c 
            FROM AgriEdge_Order__c 
            WHERE Id IN :orderIds AND Order_Status__c = 'New'
        ];

        if (!ordersToUpdate.isEmpty()) {
            for (AgriEdge_Order__c order : ordersToUpdate) {
                order.Order_Status__c = 'Processing';
            }
            update ordersToUpdate;
        }
    }
}

// ===========================
// Apex Class: OrderTotalUpdater
// ===========================
public class OrderTotalUpdater {
    public static void updateOrderTotal(Set<Id> orderIds) {
        if (orderIds == null || orderIds.isEmpty()) return;

        Map<Id, Decimal> orderTotals = new Map<Id, Decimal>();

        for (AggregateResult ar : [
            SELECT AgriEdge_Order__c orderId, SUM(Total_Price__c) totalAmount
            FROM AgriEdge_OrderItem__c 
            WHERE AgriEdge_Order__c IN :orderIds
            GROUP BY AgriEdge_Order__c
        ]) {
            orderTotals.put((Id) ar.get('orderId'), (Decimal) ar.get('totalAmount'));
        }

        List<AgriEdge_Order__c> ordersToUpdate = new List<AgriEdge_Order__c>();

        for (AgriEdge_Order__c order : [
            SELECT Id, Total_Amount__c, Payment_Status__c 
            FROM AgriEdge_Order__c 
            WHERE Id IN :orderIds
        ]) {
            order.Total_Amount__c = orderTotals.containsKey(order.Id) ? orderTotals.get(order.Id) : 0;
            order.Payment_Status__c = (order.Total_Amount__c > 0) ? 'Pending' : 'Paid';
            ordersToUpdate.add(order);
        }

        if (!ordersToUpdate.isEmpty()) update ordersToUpdate;
    }
}

// ===========================
// Apex Trigger: OrderItemTrigger
// ===========================
trigger OrderItemTrigger on AgriEdge_OrderItem__c (after insert, after update) {
    Set<Id> orderIds = new Set<Id>();

    for (AgriEdge_OrderItem__c orderItem : Trigger.new) {
        if (orderItem.AgriEdge_Order__c != null) {
            orderIds.add(orderItem.AgriEdge_Order__c);
        }
    }

    if (!orderIds.isEmpty()) {
        OrderStatusUpdater.updateOrderStatus(orderIds);
        OrderTotalUpdater.updateOrderTotal(orderIds);
    }
}

// ===========================
// Apex Class: OrderEmailSender
// ===========================
public class OrderEmailSender {
    public static void sendOrderEmail(Set<Id> orderIds) {
        if (orderIds == null || orderIds.isEmpty()) return;

        List<AgriEdge_Order__c> orders = [
            SELECT Id, Name, Total_Amount__c, Payment_Status__c, Order_Status__c, 
                   Customer__c, CreatedDate, Shipping_Address__c, Discounted_Total__c
            FROM AgriEdge_Order__c
            WHERE Id IN :orderIds
        ];

        Set<Id> accountIds = new Set<Id>();
        for (AgriEdge_Order__c order : orders) {
            if (order.Customer__c != null) accountIds.add(order.Customer__c);
        }

        Map<Id, List<String>> accountEmails = new Map<Id, List<String>>();
        for (Contact contact : [
            SELECT Email, AccountId FROM Contact WHERE AccountId IN :accountIds AND Email != null
        ]) {
            if (!accountEmails.containsKey(contact.AccountId)) {
                accountEmails.put(contact.AccountId, new List<String>());
            }
            accountEmails.get(contact.AccountId).add(contact.Email);
        }

        List<Messaging.SingleEmailMessage> emails = new List<Messaging.SingleEmailMessage>();

        for (AgriEdge_Order__c order : orders) {
            if (accountEmails.containsKey(order.Customer__c)) {
                List<String> toEmails = accountEmails.get(order.Customer__c);

                String emailBody = 'Dear Customer,<br/><br/>' +
                    'Your order has been updated with the following details:<br/><br/>' +
                    '<b>Order Name:</b> ' + order.Name + '<br/>' +
                    '<b>Order Status:</b> ' + order.Order_Status__c + '<br/>' +
                    '<b>Total Amount:</b> ' + order.Total_Amount__c + '<br/>' +
                    '<b>Payment Status:</b> ' + order.Payment_Status__c + '<br/>' +
                    '<b>Shipping Address:</b> ' + order.Shipping_Address__c + '<br/>' +
                    '<b>Created Date:</b> ' + order.CreatedDate + '<br/><br/>' +
                    '<b>Total Amount Paid (Including Discount):</b> ' + order.Discounted_Total__c + '<br/><br/>' +
                    'Thank you for your business!<br/><br/>' +
                    'Best Regards,<br/>Your Company Name';

                Messaging.SingleEmailMessage email = new Messaging.SingleEmailMessage();
                email.setToAddresses(toEmails);
                email.setSubject('Your Order Payment Status has been Updated');
                email.setHtmlBody(emailBody);
                
                emails.add(email);
            }
        }

        if (!emails.isEmpty()) Messaging.sendEmail(emails);
    }
}

// ===========================
// Apex Trigger: OrderPaymentStatusTriggers
// ===========================
trigger OrderPaymentStatusTriggers on AgriEdge_Order__c (after update) {
    Set<Id> updatedOrderIds = new Set<Id>();

    for (AgriEdge_Order__c order : Trigger.new) {
        AgriEdge_Order__c oldOrder = Trigger.oldMap.get(order.Id);
        if (oldOrder.Payment_Status__c != 'Paid' && order.Payment_Status__c == 'Paid' && order.Customer__c != null) {
            updatedOrderIds.add(order.Id);
        }
    }

    if (!updatedOrderIds.isEmpty()) {
        OrderEmailSender.sendOrderEmail(updatedOrderIds);
    }
}

// ===========================
// Apex Class: AgriEdgeOrderShipmentHelper
// ===========================
public class AgriEdgeOrderShipmentHelper {
    public static void processOrderStatusChange(List<AgriEdge_Order__c> updatedOrders) {
        List<AgriEdge_Shipment__c> shipmentsToInsert = new List<AgriEdge_Shipment__c>();
        List<AgriEdge_Shipment__c> shipmentsToUpdate = new List<AgriEdge_Shipment__c>();
        List<AgriEdge_Order__c> ordersToUpdate = new List<AgriEdge_Order__c>();
        List<AgriEdge_OrderItem__c> orderItemsToDelete = new List<AgriEdge_OrderItem__c>();
        List<AgriEdge_Shipment__c> shipmentsToDelete = new List<AgriEdge_Shipment__c>();
        
        Set<Id> orderIds = new Set<Id>();
        for (AgriEdge_Order__c order : updatedOrders) orderIds.add(order.Id);

        Map<Id, AgriEdge_Shipment__c> existingShipments = new Map<Id, AgriEdge_Shipment__c>();
        for (AgriEdge_Shipment__c shipment : [
            SELECT Id, AgriEdge_Order__c, Status__c 
            FROM AgriEdge_Shipment__c 
            WHERE AgriEdge_Order__c IN :orderIds
        ]) existingShipments.put(shipment.AgriEdge_Order__c, shipment);

        Map<Id, List<AgriEdge_OrderItem__c>> existingOrderItems = new Map<Id, List<AgriEdge_OrderItem__c>>();
        for (AgriEdge_OrderItem__c orderItem : [
            SELECT Id, AgriEdge_Order__c 
            FROM AgriEdge_OrderItem__c 
            WHERE AgriEdge_Order__c IN :orderIds
        ]) {
            if (!existingOrderItems.containsKey(orderItem.AgriEdge_Order__c)) {
                existingOrderItems.put(orderItem.AgriEdge_Order__c, new List<AgriEdge_OrderItem__c>());
            }
            existingOrderItems.get(orderItem.AgriEdge_Order__c).add(orderItem);
        }

        for (AgriEdge_Order__c order : updatedOrders) {
            AgriEdge_Order__c updatedOrder = order.clone(false, true, false, false);
            updatedOrder.Id = order.Id;
            
            if (order.Payment_Status__c == 'Paid' && order.Order_Status__c != 'Delivered') {
                updatedOrder.Order_Status__c = 'Delivered';
                ordersToUpdate.add(updatedOrder);
            } else if (order.Payment_Status__c == 'Pending') {
                updatedOrder.Order_Status__c = 'Processing';
                ordersToUpdate.add(updatedOrder);
            } else if (order.Payment_Status__c == 'Failed') {
                updatedOrder.Order_Status__c = 'Canceled';
                ordersToUpdate.add(updatedOrder);
                
                if (existingOrderItems.containsKey(order.Id)) {
                    orderItemsToDelete.addAll(existingOrderItems.get(order.Id));
                }
                if (existingShipments.containsKey(order.Id)) {
                    shipmentsToDelete.add(existingShipments.get(order.Id));
                }
            }

            if (order.Order_Status__c == 'Processing' && !existingShipments.containsKey(order.Id)) {
                AgriEdge_Shipment__c newShipment = new AgriEdge_Shipment__c(
                    AgriEdge_Order__c = order.Id,
                    Tracking_Number__c = 'TEST_' + order.Id,
                    Status__c = 'Pending'
                );
                shipmentsToInsert.add(newShipment);
            } else if (order.Order_Status__c == 'Shipped' || order.Order_Status__c == 'Delivered') {
                if (existingShipments.containsKey(order.Id)) {
                    AgriEdge_Shipment__c shipmentToUpdate = existingShipments.get(order.Id);
                    shipmentToUpdate.Status__c = (order.Order_Status__c == 'Shipped') ? 'In Transit' : 'Delivered';
                    shipmentsToUpdate.add(shipmentToUpdate);
                }
            }
        }

        if (!ordersToUpdate.isEmpty()) update ordersToUpdate;
        if (!shipmentsToInsert.isEmpty()) insert shipmentsToInsert;
        if (!shipmentsToUpdate.isEmpty()) update shipmentsToUpdate;
        if (!orderItemsToDelete.isEmpty()) delete orderItemsToDelete;
        if (!shipmentsToDelete.isEmpty()) delete shipmentsToDelete;
    }
}

// ===========================
// Apex Class: AgriEdgeOrderTriggerHelper
// ===========================
public class AgriEdgeOrderTriggerHelper {
    public static Boolean isTriggerExecuted = false;
}

// ===========================
// Apex Trigger: AgriEdgeOrderTrigger
// ===========================
trigger AgriEdgeOrderTrigger on AgriEdge_Order__c (after insert, after update) {
    if (AgriEdgeOrderTriggerHelper.isTriggerExecuted) return;
    AgriEdgeOrderTriggerHelper.isTriggerExecuted = true;

    List<AgriEdge_Order__c> relevantOrders = new List<AgriEdge_Order__c>();
    List<AgriEdge_Order__c> ordersToUpdate = new List<AgriEdge_Order__c>();
    List<Id> failedOrderIds = new List<Id>();

    for (AgriEdge_Order__c order : Trigger.new) {
        AgriEdge_Order__c oldOrder = null;
        if (Trigger.isUpdate) oldOrder = Trigger.oldMap.get(order.Id);

        Boolean paymentStatusChanged = (oldOrder == null || order.Payment_Status__c != oldOrder.Payment_Status__c);
        Boolean orderStatusChanged = (oldOrder == null || order.Order_Status__c != oldOrder.Order_Status__c);

        if (Trigger.isInsert || paymentStatusChanged || orderStatusChanged) {
            relevantOrders.add(order);
        }

        if (order.Payment_Status__c == 'Pending' && order.Order_Status__c != 'Processing') {
            ordersToUpdate.add(new AgriEdge_Order__c(Id = order.Id, Order_Status__c = 'Processing'));
        }
        if (order.Payment_Status__c == 'Failed') {
            ordersToUpdate.add(new AgriEdge_Order__c(Id = order.Id, Order_Status__c = 'Canceled'));
            failedOrderIds.add(order.Id);
        }
    }

    if (!ordersToUpdate.isEmpty()) update ordersToUpdate;

    if (!failedOrderIds.isEmpty()) {
        List<AgriEdge_OrderItem__c> orderItemsToDelete = [SELECT Id FROM AgriEdge_OrderItem__c WHERE Order__c IN :failedOrderIds];
        List<AgriEdge_Shipment__c> shipmentsToDelete = [SELECT Id FROM AgriEdge_Shipment__c WHERE Order__c IN :failedOrderIds];

        if (!orderItemsToDelete.isEmpty()) delete orderItemsToDelete;
        if (!shipmentsToDelete.isEmpty()) delete shipmentsToDelete;
    }

    if (!relevantOrders.isEmpty()) AgriEdgeOrderShipmentHelper.processOrderStatusChange(relevantOrders);

    AgriEdgeOrderTriggerHelper.isTriggerExecuted = false;
}
